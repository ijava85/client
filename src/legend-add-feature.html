<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../bower_components/firebase-element/firebase-collection.html">

<dom-module id="legend-add-feature">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    
    <paper-fab 
      on-down="startLongPress"
      on-up="endLongPress"
      on-tap="grabFeature"
      icon="[[fabIcon]]"></paper-fab>

    <firebase-collection id="waypoints"
      location="https://legend-2ab75.firebaseio.com/waypoints"
      on-firebase-value="_firebaseLoaded"
      data="{{waypoints}}"></firebase-collection>
  </template>

  <script>
    Polymer({
      is: 'legend-add-feature',
      properties: {
        locations: {
          type: Object,
          notify: true,
          reflectToAttribute: true
        },
        waypoints: {
          type: Object,
          notify: true
        },
        pressTimeout: Number,
        isRecording: {
          type: Boolean,
          value: false
        },
        fabIcon: {
          type: String,
          notify: true,
          value: "icons:add"
        }
      },
      _firebaseLoaded: function(x) {
        this.locations = this.waypoints;
        console.log(this.locations);
      },
      ready: function() {
        setInterval(this.recordPointIfRecordingEnabled.bind(this), 1000);
      },
      recordPointIfRecordingEnabled: function() {
        this.isRecording && this.addNewWaypoint();
      },
      startLongPress: function() {
        this.pressTimeout = setTimeout(this.startRecording.bind(this), 1200);
      },
      endLongPress: function() {
        clearTimeout(this.pressTimeout);
      },
      grabFeature: function() {
        if(this.isRecording) {
          this.stopRecording();
          return;
        }

        this.addNewWaypoint();
      },
      startRecording() {
        this.fabIcon = "av:pause";
        this.isRecording = true;
      },
      stopRecording() {
        this.fabIcon = "icons:add";
        this.isRecording = false;
      },
      addNewWaypoint() {
        this.$.waypoints.add({
          latitude: this.latitude,
          longitude: this.longitude
        });
      }
    });
  </script>
</dom-module>